Bootstrap: docker
From: emscripten/emsdk:3.1.61

%help
    Container for generating PHP-WASM with libxml2 and SQLite.
    The SIF only sets up the environment and build tools.
    Everything else (downloading sources and compiling) happens at runtime when you execute:
    
    apptainer run [--env VAR=value ...] container.sif
    
    Optional environment variables (defaults shown):

    * LIBXML2_TAG=v2.9.10
    * PHP_BRANCH=php-8.5.0RC5
    * WASM_ENVIRONMENT=web
    * JAVASCRIPT_EXTENSION=mjs
    * EXPORT_NAME=createPhpModule
    * MODULARIZE=1
    * EXPORT_ES6=1
    * ASSERTIONS=0
    * OPTIMIZE=-O3
    * INITIAL_MEMORY=128mb
    * TMPDIR=/tmp (can be mounted from the host for more space)
    
    Example usage with default settings (no custom variables):
    
    apptainer build php-wasm.sif php-wasm.def
    apptainer run 
        -B "$(pwd)/temp":/tmp 
        -B "$(pwd)/source":/src 
        -B "$(pwd)":/output 
        php-wasm.sif

    * /tmp → temporary workspace for building (e.g., /tmp/build)
    * /src → your source code (phpw.c)
    * /output → final .wasm and .mjs files

    This will compile PHP-WASM using the default versions of libxml2 and PHP and place the output files in the current working directory.

%environment
    export PATH=/usr/local/bin:$PATH

%post
    set -e

    # Instalar herramientas necesarias para compilar
    apt-get update && \
    apt-get --no-install-recommends -y install \
        build-essential automake autoconf libtool pkgconf \
        python3 bison flex make re2c gdb git \
        libxml2-dev unzip wget pv curl patch

    mkdir -p /output

%files
    ./source /src/source

%runscript
    set -e

    # --- Carpetas temporales ---
    export TMPDIR=${TMPDIR:-/tmp}
    export EMCC_TEMP_DIR=${TMPDIR}
    mkdir -p "$TMPDIR" "$EMCC_TEMP_DIR"

    # Workspace temporal para builds
    BUILD_DIR="$TMPDIR/build"
    mkdir -p "$BUILD_DIR"

    # --- Variables de compilación ---
    export LIBXML2_TAG="${LIBXML2_TAG:-v2.9.10}"
    export PHP_BRANCH="${PHP_BRANCH:-php-8.5.0RC5}"
    export WASM_ENVIRONMENT="${WASM_ENVIRONMENT:-web}"
    export JAVASCRIPT_EXTENSION="${JAVASCRIPT_EXTENSION:-mjs}"
    export EXPORT_NAME="${EXPORT_NAME:-createPhpModule}"
    export MODULARIZE="${MODULARIZE:-1}"
    export EXPORT_ES6="${EXPORT_ES6:-1}"
    export ASSERTIONS="${ASSERTIONS:-0}"
    export OPTIMIZE="${OPTIMIZE:--Oz}"
    export INITIAL_MEMORY="${INITIAL_MEMORY:-128mb}"

    echo "Preparing PHP-WASM compilation..."

    # --- LIBXML2 ---
    echo "Downloading libxml2 ($LIBXML2_TAG)..."
    cd "$BUILD_DIR"
    git clone --branch "$LIBXML2_TAG" --single-branch --depth 1 https://gitlab.gnome.org/GNOME/libxml2.git libxml2
    cd libxml2
    ./autogen.sh
    emconfigure ./configure --prefix="$BUILD_DIR/libxml2/build" --enable-static --disable-shared --with-python=no --with-threads=no
    emmake make -j$(nproc)
    emmake make install

    # --- SQLITE ---
    echo "Downloading/compiling SQLite..."
    cd "$BUILD_DIR"
    wget https://sqlite.org/2020/sqlite-amalgamation-3330000.zip
    unzip sqlite-amalgamation-3330000.zip
    rm sqlite-amalgamation-3330000.zip
    SQLITE_DIR="$BUILD_DIR/sqlite-amalgamation-3330000"
    emcc -Oz -DSQLITE_OMIT_LOAD_EXTENSION -DSQLITE_DISABLE_LFS -DSQLITE_ENABLE_FTS3 \
         -DSQLITE_ENABLE_FTS3_PARENTHESIS -DSQLITE_THREADSAFE=0 -DSQLITE_ENABLE_NORMALIZE \
         -c "$SQLITE_DIR/sqlite3.c" -o "$BUILD_DIR/sqlite3.o"

    # --- ONIGURUMA (mbregex) ---
    echo "Compiling Oniguruma..."
    cd "$BUILD_DIR"
    git clone https://github.com/kkos/oniguruma.git
    cd oniguruma
    autoreconf -fi
    emconfigure ./configure \
        --enable-static \
        --disable-shared \
        --disable-dependency-tracking \
        --disable-nls \
        --disable-maintainer-mode \
        --disable-doc \
        --disable-samples \
        --prefix="$BUILD_DIR/onig-build"
    emmake make -j$(nproc)
    emmake make install

    export ONIG_CFLAGS="-I$BUILD_DIR/onig-build/include"
    export ONIG_LIBS="-L$BUILD_DIR/onig-build/lib -lonig"
    export CFLAGS="$CFLAGS $ONIG_CFLAGS"
    export CPPFLAGS="$CPPFLAGS $ONIG_CFLAGS"
    export LDFLAGS="$LDFLAGS $ONIG_LIBS"

    echo "Oniguruma compiled and environment variables set."


    # --- PHP ---
    echo "Downloading PHP ($PHP_BRANCH)..."
    cd "$BUILD_DIR"
    git clone --branch "$PHP_BRANCH" --single-branch --depth 1 https://github.com/php/php-src.git php-src
    cd php-src
    ./buildconf --force

    export LIBXML_LIBS="-L$BUILD_DIR/libxml2/build/lib"
    export LIBXML_CFLAGS="-I$BUILD_DIR/libxml2/build/include/libxml2"
    export SQLITE_LIBS="-L$BUILD_DIR"
    export SQLITE_CFLAGS="-I$SQLITE_DIR"

    # --- APLICAR PARCHE PARA REALLOCARRAY ANTES DE CONFIGURAR ---
    echo "Aplicando parches para PHP 8.5..."
    
    # Solución para reallocarray - definir HAVE_REALLOCARRAY
    export CFLAGS="$CFLAGS -DHAVE_REALLOCARRAY"
    export CPPFLAGS="$CPPFLAGS -DHAVE_REALLOCARRAY"
    
    # Parche adicional para php_glob.c
    if [ -f "main/php_glob.c" ]; then
        echo "Parcheando main/php_glob.c..."
        sed -i 's/^static void \*reallocarray/\/\/ static void *reallocarray/' main/php_glob.c
        sed -i 's/^reallocarray(void \*optr/\/\/ reallocarray(void *optr/' main/php_glob.c
    fi

    # Parchear otros archivos que puedan tener el mismo problema
    find . -name "*.c" -type f -exec grep -l "reallocarray" {} \; | head -5 | while read file; do
        echo "Parcheando $file..."
        sed -i 's/^static reallocarray/\/\/ static reallocarray/g' "$file"
        sed -i 's/^reallocarray(/\/\/ reallocarray(/g' "$file" 2>/dev/null || true
    done

    emconfigure ./configure \
        --enable-embed=static \
        --with-layout=GNU \
        --with-libxml \
        --enable-xml \
        --disable-cgi \
        --disable-cli \
        --disable-fiber-asm \
        --disable-all \
        --enable-session \
        --enable-filter \
        --enable-calendar \
        --enable-dom \
        --disable-rpath \
        --disable-phpdbg \
        --without-pear \
        --with-valgrind=no \
        --without-pcre-jit \
        --with-pcre \
        --disable-opcache-jit \
        --disable-opcache \
        --enable-bcmath \
        --enable-json \
        --enable-ctype \
        --enable-mbstring \
        --enable-mbregex \
        --with-config-file-scan-dir=/src/php \
        --enable-tokenizer \
        --enable-simplexml \
        --enable-pdo \
        --with-pdo-sqlite \
        --enable-fileinfo \
        --enable-hash \
        --with-sqlite3

    # --- APLICAR PARCHE ADICIONAL SI ES NECESARIO DESPUÉS DE CONFIGURAR ---
    echo "Aplicando parches finales..."
    
    # Asegurar que los archivos objeto se regeneren con los parches
    if [ -f "main/php_glob.c" ]; then
        touch main/php_glob.c
    fi

    # Limpiar objetos anteriores para forzar recompilación
    find . -name "*.lo" -delete 2>/dev/null || true
    find . -name "*.o" -delete 2>/dev/null || true

    emmake make -j$(nproc)

    bash -c '[[ -f .libs/libphp7.la ]] && mv .libs/libphp7.la .libs/libphp.la && mv .libs/libphp7.a .libs/libphp.a && mv .libs/libphp7.lai .libs/libphp.lai || exit 0'

    # --- Compilar phpw.c a WASM ---
    emcc $OPTIMIZE \
        -I. -IZend -Imain -ITSRM/ \
        -c /src/phpw.c \
        -o "$BUILD_DIR/phpw.o" \
        2>/dev/null  # Ignora warnings de linker en compilación de objeto

    emcc $OPTIMIZE \
        -o /output/php-$WASM_ENVIRONMENT.$JAVASCRIPT_EXTENSION \
        --llvm-lto 2 \
        -s EXPORTED_FUNCTIONS='["_phpw","_phpw_flush","_phpw_exec","_phpw_run","_chdir","_setenv","_php_embed_init","_php_embed_shutdown","_zend_eval_string"]' \
        -s EXPORTED_RUNTIME_METHODS='["ccall","UTF8ToString","lengthBytesUTF8","FS"]' \
        -s ENVIRONMENT="$WASM_ENVIRONMENT" \
        -s FORCE_FILESYSTEM=1 \
        -s MAXIMUM_MEMORY=1gb \
        -s INITIAL_MEMORY="$INITIAL_MEMORY" \
        -s ALLOW_MEMORY_GROWTH=1 \
        -s ASSERTIONS="$ASSERTIONS" \
        -s ERROR_ON_UNDEFINED_SYMBOLS=0 \
        -s MODULARIZE="$MODULARIZE" \
        -s INVOKE_RUN=0 \
        -s LZ4=1 \
        -s EXPORT_ES6="$EXPORT_ES6" \
        -s EXPORT_NAME="$EXPORT_NAME" \
        -lidbfs.js \
        "$BUILD_DIR/phpw.o" "$BUILD_DIR/sqlite3.o" .libs/libphp.a "$BUILD_DIR/libxml2/build/lib/libxml2.a" "$BUILD_DIR/onig-build/lib/libonig.a"

    echo "PHP-WASM generated in /output"
    cp /output/*.wasm "$PWD" 2>/dev/null || true
    cp /output/*.mjs "$PWD" 2>/dev/null || true
    echo "All Done!"
